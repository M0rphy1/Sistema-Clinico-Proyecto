<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Citas</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css">
</head>
<body>
    <div class="container mt-5">
        <h1>Gestión de Citas</h1>
        <button class="btn btn-primary" data-toggle="modal" data-target="#registroCitaModal">Registrar Cita</button>
        <button class="btn btn-secondary" data-toggle="modal" data-target="#actualizarCitaModal">Actualizar Cita</button>
        <button class="btn btn-info" data-toggle="modal" data-target="#buscarCitaModal">Buscar Cita</button>
        <button class="btn btn-danger" data-toggle="modal" data-target="#eliminarCitaModal">Eliminar Cita</button>
        <div id="calendar"></div> <!-- Aquí se mostrará el calendario -->
    </div>
    
    <!-- Modal para Registrar Cita -->
    <div class="modal fade" id="registroCitaModal" tabindex="-1" role="dialog" aria-labelledby="registroCitaModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="registroCitaModalLabel">Registrar Cita</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="registroCitaForm">
                        <div class="form-group">
                            <label for="nombreMascota">Nombre de la Mascota</label>
                            <input type="text" class="form-control" id="nombreMascota" required>
                        </div>
                        <div class="form-group">
                            <label for="nombreUsuario">Nombre del Médico</label>
                            <input type="text" class="form-control" id="nombreUsuario" required>
                        </div>
                        <div class="form-group">
                            <label for="nombreCliente">Nombre del Dueño de Mascota</label>
                            <input type="text" class="form-control" id="nombreCliente" required>
                        </div>
                        <div class="form-group">
                            <label for="nombreMedicamento">Nombre del Medicamento</label>
                            <input type="text" class="form-control" id="nombreMedicamento" required>
                        </div>
                        <div class="form-group">
                            <label for="nombreSuministro">Nombre del Suministro</label>
                            <input type="text" class="form-control" id="nombreSuministro" required>
                        </div>
                        <div class="form-group">
                            <label for="fechaCita">Fecha de la Cita</label>
                            <input type="date" class="form-control" id="fechaCita" required>
                        </div>
                        <div class="form-group">
                            <label for="motivo">Motivo</label>
                            <textarea class="form-control" id="motivo"></textarea>
                        </div>
                        <div class="form-group">
                            <label for="horaCita">Hora de la Cita</label>
                            <input type="time" class="form-control" id="horaCita">
                        </div>
                        <button type="submit" class="btn btn-primary">Registrar</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para Actualizar Cita -->
    <div class="modal fade" id="actualizarCitaModal" tabindex="-1" role="dialog" aria-labelledby="actualizarCitaModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="actualizarCitaModalLabel">Actualizar Cita</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="actualizarCitaForm">
                        <div class="form-group">
                            <label for="updateIdCita">ID Cita</label>
                            <input type="number" class="form-control" id="updateIdCita" required>
                        </div>
                        <div class="form-group">
                            <label for="updateNombreMascota">Nombre de la Mascota</label>
                            <input type="text" class="form-control" id="updateNombreMascota" required>
                        </div>
                        <div class="form-group">
                            <label for="updateNombreUsuario">Nombre del Usuario</label>
                            <input type="text" class="form-control" id="updateNombreUsuario" required>
                        </div>
                        <div class="form-group">
                            <label for="updateNombreCliente">Nombre del Cliente</label>
                            <input type="text" class="form-control" id="updateNombreCliente" required>
                        </div>
                        <div class="form-group">
                            <label for="updateNombreMedicamento">Nombre del Medicamento</label>
                            <input type="text" class="form-control" id="updateNombreMedicamento" required>
                        </div>
                        <div class="form-group">
                            <label for="updateNombreSuministro">Nombre del Suministro</label>
                            <input type="text" class="form-control" id="updateNombreSuministro" required>
                        </div>
                        <div class="form-group">
                            <label for="updateFechaCita">Fecha de la Cita</label>
                            <input type="date" class="form-control" id="updateFechaCita" required>
                        </div>
                        <div class="form-group">
                            <label for="updateMotivo">Motivo</label>
                            <textarea class="form-control" id="updateMotivo"></textarea>
                        </div>
                        <div class="form-group">
                            <label for="updateHoraCita">Hora de la Cita</label>
                            <input type="time" class="form-control" id="updateHoraCita">
                        </div>
                        <button type="submit" class="btn btn-primary">Actualizar</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para Buscar Cita -->
    <div class="modal fade" id="buscarCitaModal" tabindex="-1" role="dialog" aria-labelledby="buscarCitaModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="buscarCitaModalLabel">Buscar Cita</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="buscarCitaForm">
                        <div class="form-group">
                            <label for="buscarIdCita">ID Cita</label>
                            <input type="number" class="form-control" id="buscarIdCita" required>
                        </div>
                        <button type="submit" class="btn btn-primary">Buscar</button>
                    </form>
                    <div id="buscarCitaResultado" class="mt-3"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para Eliminar Cita -->
    <div class="modal fade" id="eliminarCitaModal" tabindex="-1" role="dialog" aria-labelledby="eliminarCitaModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="eliminarCitaModalLabel">Eliminar Cita</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="eliminarCitaForm">
                        <div class="form-group">
                            <label for="eliminarIdCita">ID Cita</label>
                            <input type="number" class="form-control" id="eliminarIdCita" required>
                        </div>
                        <button type="submit" class="btn btn-danger">Eliminar</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
<!-- Contenedor para mensajes -->
<div id="mensajeResultado" class="alert" role="alert" style="display:none;"></div>

    <script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.11.0/umd/popper.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"></script>
    <script>
    // Función para mostrar mensajes
    function mostrarMensaje(mensaje, tipo) {
        const mensajeResultado = document.getElementById('mensajeResultado');
        mensajeResultado.textContent = mensaje;
        mensajeResultado.className = `alert alert-${tipo}`;
        mensajeResultado.style.display = 'block';
    }

// Función para registrar una cita
document.getElementById('registroCitaForm').addEventListener('submit', async function(event) {
    event.preventDefault();

    const nombreMascota = document.getElementById('nombreMascota').value;
    const nombreUsuario = document.getElementById('nombreUsuario').value;
    const nombreCliente = document.getElementById('nombreCliente').value;
    const nombreMedicamento = document.getElementById('nombreMedicamento').value;
    const nombreSuministro = document.getElementById('nombreSuministro').value;
    const fechaCita = document.getElementById('fechaCita').value;
    const motivo = document.getElementById('motivo').value;
    const horaCita = document.getElementById('horaCita').value;

    try {
        const response = await fetch('/api/citas', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                nombreMascota,
                nombreUsuario,
                nombreCliente,
                nombreMedicamento,
                nombreSuministro,
                fechaCita,
                motivo,
                horaCita
            })
        });

        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.message);
        }

        mostrarMensaje('Cita registrada correctamente.', 'success');
        document.getElementById('registroCitaForm').reset(); // Limpiar formulario después de registro

    } catch (error) {
        console.error('Error al registrar la cita:', error);
        if (error.message.includes('Ya hay una cita programada para esa fecha y hora')) {
            mostrarMensaje('Ya hay una cita programada para esa fecha y hora. Por favor, elige otra fecha u hora.', 'danger');
        } else {
            mostrarMensaje('Error al registrar la cita. Verifica la consola para más detalles.', 'danger');
        }
    }
});

// Función para actualizar una cita
document.getElementById('actualizarCitaForm').addEventListener('submit', function(event) {
    event.preventDefault();
    const idCita = document.getElementById('updateIdCita').value;
    const nombreMascota = document.getElementById('updateNombreMascota').value;
    const nombreUsuario = document.getElementById('updateNombreUsuario').value;
    const nombreCliente = document.getElementById('updateNombreCliente').value;
    const nombreMedicamento = document.getElementById('updateNombreMedicamento').value;
    const nombreSuministro = document.getElementById('updateNombreSuministro').value;
    const fechaCita = document.getElementById('updateFechaCita').value;
    const motivo = document.getElementById('updateMotivo').value;
    const horaCita = document.getElementById('updateHoraCita').value;

    fetch(`/api/citas/${idCita}`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            idCita: idCita,
            nombreMascota: nombreMascota,
            nombreUsuario: nombreUsuario,
            nombreCliente: nombreCliente,
            nombreMedicamento: nombreMedicamento,
            nombreSuministro: nombreSuministro,
            fechaCita: fechaCita,
            motivo: motivo,
            horaCita: horaCita
        }),
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            mostrarMensaje(data.error, 'danger');
        } else {
            mostrarMensaje('Cita actualizada correctamente.', 'success');
        }
    })
    .catch((error) => {
        console.error('Error al actualizar la cita:', error);
        mostrarMensaje('Error al actualizar la cita. Verifica la consola para más detalles.', 'danger');
    });
});

// Función para buscar una cita por ID
document.getElementById('buscarCitaForm').addEventListener('submit', function(event) {
    event.preventDefault();
    const buscarIdCita = document.getElementById('buscarIdCita').value;

    fetch(`/api/citas/${buscarIdCita}`)
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            mostrarMensaje(data.error, 'danger');
        } else {
            const resultado = document.getElementById('buscarCitaResultado');
            resultado.innerHTML = `
                <h5>ID Cita: ${data.idCita}</h5>
                <p>Nombre Mascota: ${data.Mascotum ? data.Mascotum.nombreMascota : 'No especificado'}</p>
                <p>Nombre Usuario: ${data.Usuario.nombreUsuario}</p>
                <p>Nombre Cliente: ${data.Cliente ? data.Cliente.nombreCliente : 'No especificado'}</p>
                <p>Nombre Medicamento: ${data.Medicamento ? data.Medicamento.nombreMedicamento : 'No especificado'}</p>
                <p>Nombre Suministro: ${data.Suministro ? data.Suministro.nombreSuministro : 'No especificado'}</p>
                <p>Fecha Cita: ${data.fechaCita}</p>
                <p>Motivo: ${data.motivo}</p>
                <p>Hora Cita: ${data.horaCita}</p>
            `;
            mostrarMensaje('Cita encontrada.', 'success');
        }
    })
    .catch((error) => {
        console.error('Error al buscar la cita:', error);
        mostrarMensaje('Error al buscar la cita. Verifica la consola para más detalles.', 'danger');
    });
});

// Función para eliminar una cita por ID
document.getElementById('eliminarCitaForm').addEventListener('submit', async function(event) {
    event.preventDefault();
    const idCita = document.getElementById('eliminarIdCita').value;

    if (confirm(`¿Estás seguro de eliminar la cita con ID ${idCita}?`)) {
        try {
            const response = await fetch(`/api/citas/${idCita}`, {
                method: 'DELETE',
            });

            if (response.status === 204) {
                mostrarMensaje('Cita eliminada exitosamente.', 'success');
            } else {
                const errorData = await response.json();
                throw new Error(errorData.message);
            }
        } catch (error) {
            console.error('Error al eliminar la cita:', error);
            mostrarMensaje('Error al eliminar la cita. Verifica la consola para más detalles.', 'danger');
        }
    }
});

document.getElementById('buscarCitaForm').addEventListener('submit', async function(event) {
    event.preventDefault();
    const buscarIdCita = document.getElementById('buscarIdCita').value;

    try {
        const response = await fetch(`/api/citas/${buscarIdCita}`);

        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.message);
        }

        const data = await response.json();
        const resultado = document.getElementById('buscarCitaResultado');
        resultado.innerHTML = `
            <h5>ID Cita: ${data.id}</h5>
            <p>Nombre Mascota: ${data.Mascotum ? data.Mascotum.nombreMascota : 'No especificado'}</p>
            <p>Nombre Usuario: ${data.Usuario ? data.Usuario.nombreUsuario : 'No especificado'}</p>
            <p>Nombre Cliente: ${data.Cliente ? data.Cliente.nombreCliente : 'No especificado'}</p>
            <p>Nombre Medicamento: ${data.Medicamento ? data.Medicamento.nombreMedicamento : 'No especificado'}</p>
            <p>Nombre Suministro: ${data.Suministro ? data.Suministro.nombreSuministro : 'No especificado'}</p>
            <p>Fecha Cita: ${data.fechaCita}</p>
            <p>Motivo: ${data.motivo}</p>
            <p>Hora Cita: ${data.horaCita}</p>
        `;
        mostrarMensaje('Cita encontrada.', 'success');
    } catch (error) {
        console.error('Error al buscar la cita:', error);
        mostrarMensaje('Error al buscar la cita. Verifica la consola para más detalles.', 'danger');
    }
});

function mostrarMensaje(mensaje, tipo) {
    const mensajeResultado = document.getElementById('mensajeResultado');
    mensajeResultado.textContent = mensaje;
    mensajeResultado.className = `alert alert-${tipo}`;
    mensajeResultado.style.display = 'block';
    setTimeout(() => {
        mensajeResultado.style.display = 'none';
    }, 3000);
}

    </script>
</body>
</html>

